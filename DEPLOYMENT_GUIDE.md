# Deployment Guide - Perplexity OSS

## Quick Start (For Hackathon Judges & Users)

### 1. Get Your Lyzr API Key

Visit [Lyzr Agent Studio](https://studio.lyzr.ai) and get your API key.

### 2. Create `.env` File

```bash
# In the root directory, create .env with just your API key:
LYZR_API_KEY=your_actual_api_key_here
```

That's it! No need to manually create agents.

### 3. Start the Application

```bash
docker-compose up --build
```

**First startup will:**
1. Auto-create 5 Lyzr agents (~30 seconds)
2. Save agent IDs to persistent storage
3. Start the application

**Subsequent startups:**
- Loads saved agent IDs (instant)
- No API calls needed

### 4. Access the App

- Frontend: http://localhost:3003
- Backend API: http://localhost:8003
- SearXNG: http://localhost:8083

## What Happens Behind the Scenes

### First Run

```
ðŸš€ Perplexity OSS - Initializing...
============================================================
ðŸ¤– Auto-creating Lyzr agents for Perplexity OSS...
============================================================

Creating answer_generation agent: Answer Generation Agent - Perplexity OSS...
âœ“ Created answer_generation agent with ID: 12345

Creating query_rephrase agent: Query Rephraser - Perplexity OSS...
âœ“ Created query_rephrase agent with ID: 12346

... (3 more agents) ...

âœ“ All agents created successfully!
âœ“ Saved agent IDs to /app/config/agents.json

âœ… All agents initialized successfully!
   Agent IDs: ['query_rephrase', 'answer_generation', 'related_questions', 'query_planning', 'search_query']
```

### Subsequent Runs

```
ðŸš€ Perplexity OSS - Initializing...
âœ“ Loaded agent IDs from config file: /app/config/agents.json
âœ… All agents initialized successfully!
```

## Troubleshooting

### Error: "Could not find agent ID in response"

**Problem:** Lyzr API response structure changed.

**Solution:** The code handles both `id` and `agent_id` in the response. Check logs for actual response structure:

```
API Response for answer_generation: {actual response here}
```

If you see a different structure, update `backend/src/config/agent_manager.py` line 185-192.

### Error: "this event loop is already running"

**Fixed!** Agents are now created at app startup, not per-request.

### Error: "Agent ID for ... is not configured"

**Cause:** Agents weren't created at startup (API key issue or network problem).

**Solution:**
1. Check your `LYZR_API_KEY` is valid
2. Check logs for startup errors
3. Ensure you have internet access (to reach Lyzr API)
4. Restart: `docker-compose down && docker-compose up --build`

### Manual Agent Setup (Fallback)

If auto-creation fails, you can manually create agents:

1. Go to [Lyzr Agent Studio](https://studio.lyzr.ai)
2. Clone the Perplexity OSS blueprint
3. Copy each agent ID
4. Add to your `.env`:

```bash
LYZR_API_KEY=your_api_key
LYZR_QUERY_REPHRASE_AGENT_ID=agent_id_1
LYZR_ANSWER_GENERATION_AGENT_ID=agent_id_2
LYZR_RELATED_QUESTIONS_AGENT_ID=agent_id_3
LYZR_QUERY_PLANNING_AGENT_ID=agent_id_4
LYZR_SEARCH_QUERY_AGENT_ID=agent_id_5
```

5. Restart the application

## Lyzr API Response Format

The Lyzr Agent Studio API returns:

```json
{
  "agent_id": 12345,
  "message": "Agent created successfully."
}
```

Our code handles multiple response formats for compatibility.

## Configuration Files

### `/app/config/agents.json` (Docker Volume)

This file is automatically created and persists across container restarts:

```json
{
  "agent_ids": {
    "query_rephrase": "12345",
    "answer_generation": "12346",
    "related_questions": "12347",
    "query_planning": "12348",
    "search_query": "12349"
  },
  "created_at": "2025-10-16T12:00:00.000000",
  "api_base": "https://agent-prod.studio.lyzr.ai",
  "note": "Auto-generated by Perplexity OSS. Do not edit manually unless necessary."
}
```

**To reset agents:**
```bash
docker-compose down -v  # Remove volumes
docker-compose up --build  # Recreate agents
```

## Production Deployment

### Environment Variables

```bash
# Required
LYZR_API_KEY=your_production_api_key

# Optional (with defaults)
LYZR_API_BASE=https://agent-prod.studio.lyzr.ai
NEXT_PUBLIC_API_URL=http://your-backend-domain:8000
NEXT_PUBLIC_PRO_MODE_ENABLED=true
SEARXNG_BASE_URL=http://searxng:8080
```

### Docker Compose Production

```yaml
services:
  backend:
    build: ./backend
    environment:
      - LYZR_API_KEY=${LYZR_API_KEY}
    volumes:
      - agent_config:/app/config  # Persist agent IDs
    restart: unless-stopped

volumes:
  agent_config:  # Important: Keeps agents across restarts
```

### Health Check

```bash
curl http://localhost:8003/health
# {"status":"healthy","service":"perplexity-oss"}
```

## Development

### Local Development Without Docker

**Backend:**
```bash
cd backend
uv pip install -r requirements.txt
cd src
export LYZR_API_KEY=your_key
uvicorn main:app --reload
```

**Frontend:**
```bash
cd frontend
npm install
npm run dev
```

On first run, agents will be created and saved to `backend/config/agents.json`.

## Support

- GitHub Issues: Report bugs and request features
- Lyzr Documentation: https://docs.lyzr.ai
- Lyzr Studio: https://studio.lyzr.ai
